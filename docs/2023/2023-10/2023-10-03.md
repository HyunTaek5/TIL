---
title: '2023-10-03'
tags:
  - PG
  - PortOne
---
# PortOne - 웹훅
웹훅
## 개념
- 특정 이벤트가 발생했을 때 타 서비스나 프로그램으로 알림을 보내는 기능
- Webhook Provider는 해당 이벤트가 발행하면 HTTP POST 메소드 요청을 생성하여 Callback Url로 이벤트 정보를 전송한다.
- 주기적으로 데이터를 폴링하지않고, 원하는 이벤트에 대한 정보만 수신가능하여 리소스나 통신측면에서 웹훅이 더 효율적이다.

## 포트원에서 웹훅 연동이 필요한 이유
- 포트원 서버에서 클라이언트에 Response를 전달할 때, 해당 기기의 Wi-Fi 연결 끊김과 같은 통신 이슈나 브라우저 자동 리로드 등의 이슈로 클라이언트에서 결제 완료 Response를 받지 못하는 경우가 간헐적으로 발생한다.
- 위와 같이 가맹점 DB에서 결제 완료 처리가 안되는 경우를 보완하기 위해서 포트원 서버에서 가맹점 서버로 webhook 이벤트를 발송하여 결제 정보 Sync를 맞춘다.

## 웹훅 발송 타이밍
결제 실패시에는 웹훅이 호출되지않는다.
- 결제 승인시 - status: paid
- 가상계좌 발급시 - status: ready
- 가상계좌 입금 완료시 - status: paid
- 예약 결제 시도시 - status: paid | failed
- 관리자 콘솔에서 결제 취소시 - status: cancelled

## 웹훅 주의점
1. 가맹점 서버에서 결제 정보를 수신하는 순서는 포트원에서 보장하지않는다.
   	1. 포트원 서버에서 webhook을 호출하면 가맹점 서버의 응답을 기다리지 않고, 302 redirect 응답을 보내기 때문에 결과 도달 순서 보장을 하지않는다. 
   	2. 가맹점의 요청이 있는 경우에만 webhook 호출이후에 클라이언트에 302 redirect/callback 응답을 보내 순서를 보장해준다.
2. 웹훅 재발송 기능이 설정되어있는 가맹점의 경우, 포트원쪽에서 동일한 내용의 웹훅이 여러 번 발신하는 경우가 있을 수도 있으니 가맹점 서버에서 해당 케이스 핸들링이 필요하다.
3. 웹훅 가맹점 서버 응답이 500번대 인 경우, 1분 가격으로 최대 5회 발송
    1. 200번대 | 400번대 응답을 서버에서 회신하면 발송이 중단된다.